<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtu√°ln√≠ Zahr√°dka</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Z√°kladn√≠ styly pro tƒõlo str√°nky - TMAV√ù RE≈ΩIM pro UI */
        body {
            font-family: 'Inter', sans-serif;
            background: #000; /* ƒåern√© pozad√≠ */
            color: #e2e8f0; /* Svƒõtl√Ω text */
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        /* Kontejner pro aplikaci */
        .container {
            max-width: 5xl; /* ≈†ir≈°√≠ kontejner pro hern√≠ plochu a invent√°≈ô */
            margin: 0 auto;
            padding: 2rem;
            background-color: #1a1a1a;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
        }

        /* Styly pro nadpis */
        h1 {
            font-size: 2.5rem;
            margin-bottom: 2rem;
            color: #facc15; /* ≈Ωlut√° barva pro nadpis */
            font-weight: 700;
            text-align: center;
        }
        h2 {
            font-size: 1.75rem;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            color: #90cdf4; /* Svƒõtlej≈°√≠ modr√° pro podnadpisy */
            font-weight: 700;
            border-bottom: 1px solid #4a5568;
            padding-bottom: 0.5rem;
        }

        /* Styly pro hern√≠ pole */
        #gardenGrid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); /* Responzivn√≠ m≈ô√≠≈æka pol√≠ƒçek */
            gap: 10px;
            padding: 15px;
            background-color: #2d3748; /* Tmav≈°√≠ pozad√≠ pro pole */
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .plot {
            width: 80px;
            height: 80px;
            background-color: #5a4a3a; /* Barva hl√≠ny */
            border: 2px solid #7a6a5a;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem; /* Velikost ikony rostliny */
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: background-color 0.1s ease-in-out;
            outline: none;
        }

        .plot:hover {
            background-color: #6a5a4a;
        }
        .plot:focus {
            outline: 3px solid #facc15;
            outline-offset: 2px;
        }

        .plant-icon {
            font-size: 2.5rem; /* Vƒõt≈°√≠ ikona rostliny */
            line-height: 1;
            text-align: center;
            position: absolute;
            bottom: 5px; /* Trochu nad spodn√≠ okraj */
            color: #4caf50; /* Zelen√° pro rostliny */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .plant-status {
            position: absolute;
            top: 5px;
            left: 5px;
            font-size: 0.7rem;
            color: #e2e8f0;
            background-color: rgba(0,0,0,0.5);
            padding: 2px 5px;
            border-radius: 3px;
        }
        .plant-status.watered {
            color: #63b3ed; /* Modr√° pro zalito */
        }
        .plant-status.dry {
            color: #f44336; /* ƒåerven√° pro sucho */
        }
        .plant-status.ready {
            color: #facc15; /* ≈Ωlut√° pro p≈ôipraveno ke sklizni */
        }
        .plant-status.pest { /* Styl pro ≈°k≈Ødce */
            background-color: #dc3545; /* ƒåerven√© pozad√≠ pro ≈°k≈Ødce */
            color: white;
        }
        /* Styl pro ikonu ≈°k≈Ødce, aby se p≈ôekr√Ωvala s rostlinou */
        .pest-icon {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            font-size: 1.5rem;
            color: #dc3545; /* ƒåerven√° pro ≈°k≈Ødce */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            z-index: 10; /* Zajist√≠, ≈æe je nad ikonou rostliny */
        }


        /* Styly pro invent√°≈ô */
        #inventory {
            background-color: #222;
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
        }
        #inventory h2 {
            border-bottom: none;
            margin-bottom: 1rem;
        }
        .inventory-items {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .inventory-item {
            background-color: #333;
            padding: 0.75rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
            color: #e2e8f0;
            cursor: pointer; /* P≈ôid√°no pro vizu√°ln√≠ indikaci klikatelnosti */
            outline: none; /* Odstranƒõn√≠ v√Ωchoz√≠ho outline pro vlastn√≠ focus styl */
        }
        .inventory-item:focus {
            border: 2px solid #facc15; /* ≈Ωlut√Ω r√°meƒçek pro focus */
        }
        .inventory-item.selected {
            border: 2px solid #63b3ed; /* Modr√Ω r√°meƒçek pro vybran√Ω p≈ôedmƒõt */
        }

        /* Styly pro tlaƒç√≠tka akc√≠ */
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        button {
            padding: 0.75rem 1.5rem;
            border: none;
            font-weight: bold;
            cursor: pointer;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease;
            color: #000; /* ƒåern√Ω text tlaƒç√≠tek pro lep≈°√≠ kontrast */
        }
        .btn-primary { background-color: #28a745; color: #fff;} /* Zelen√° */
        .btn-secondary { background-color: #ffc107; color: #000; } /* ≈Ωlut√° */
        .btn-danger { background-color: #f44336; color: #fff;} /* ƒåerven√° */
        .btn-action { background-color: #007bff; color: #fff;} /* Modr√° */
        .btn-export { background-color: #17a2b8; color: #fff; } /* Azurov√° pro export */
        .btn-import { background-color: #6f42c1; color: #fff; } /* Fialov√° pro import */
        
        button:hover { opacity: 0.9; }
        button:focus { outline: 2px solid #facc15; outline-offset: 2px; }

        /* Styl pro tlaƒç√≠tko Zpƒõt na Dashboard */
        .back-to-dashboard-link {
            display: block;
            width: fit-content;
            background-color: #4a4a4a;
            color: #fff;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            text-decoration: none;
            font-weight: bold;
            margin-bottom: 1.5rem;
            transition: background-color 0.2s ease;
        }
        .back-to-dashboard-link:hover {
            background-color: #6a6a6a;
        }
        .back-to-dashboard-link:focus {
            outline: 2px solid #facc15;
            outline-offset: 2px;
        }

        /* Styly pro mod√°ln√≠ okno */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #2d3748;
            color: #e2e8f0;
            margin: auto;
            padding: 20px;
            border: 1px solid #4a5568;
            width: 80%;
            max-width: 500px;
            border-radius: 0.75rem;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.4),0 6px 20px 0 rgba(0,0,0,0.3);
            text-align: center;
        }
        .modal-buttons {
            text-align: right;
        }
        .modal-buttons button {
            padding: 0.5rem 1rem;
            margin-left: 0.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .modal-buttons .bg-gray-500 { background-color: #4a4a4a; color: #fff; }
        .modal-buttons .bg-red-500 { background-color: #f44336; color: #fff; }

        /* Skryt√° oblast pro ƒçteƒçku obrazovky */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border-width: 0;
        }

        /* Styly pro shop modal */
        #shopContent {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .shop-section {
            background-color: #1a1a1a;
            padding: 1rem;
            border-radius: 0.5rem;
        }
        .shop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #333;
        }
        .shop-item:last-child {
            border-bottom: none;
        }
        .shop-item-info {
            flex-grow: 1;
            text-align: left;
        }
        .shop-item-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .shop-item-controls input[type="number"] {
            width: 60px;
            padding: 4px;
            background-color: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 4px;
            color: #e2e8f0;
        }
        .shop-item-controls button {
            padding: 6px 12px;
            font-size: 0.9rem;
        }

        /* Styly pro sekci √∫kol≈Ø */
        #dailyQuests {
            background-color: #222;
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin-top: 1.5rem;
            display: none; /* Skryto, dokud se neobjev√≠ √∫kol */
        }
        #dailyQuests h4 {
            font-size: 1.15rem;
            font-weight: bold;
            color: #facc15;
            margin-bottom: 0.75rem;
        }
        .quest-description {
            color: #cbd5e0;
            margin-bottom: 1rem;
            line-height: 1.5;
        }
        .quest-requirements, .quest-rewards {
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }
        .quest-requirements span, .quest-rewards span {
            font-weight: bold;
            color: #81e6d9;
        }
        .quest-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        /* Styly pro zpr√°vy pod hern√≠m polem */
        .game-messages {
            width: 100%;
            max-width: 5xl;
            margin-top: 1rem;
            min-height: 50px; /* Aby se zpr√°vy neposouvaly moc rychle */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .game-message-item {
            background-color: #4a4a4a;
            color: #e2e8f0;
            padding: 8px 15px;
            border-radius: 5px;
            opacity: 0; /* Zaƒç√≠n√° neviditeln√© */
            animation: fadeOut 5s forwards; /* Animace mizen√≠ po 5 sekund√°ch */
            width: fit-content;
            max-width: 90%;
            text-align: center;
        }

        @keyframes fadeOut {
            0% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); display: none; }
        }
    </style>
</head>
<body>
    <a href="../index.html" class="back-to-dashboard-link" aria-label="Zpƒõt na Palpatius games">‚Üê Zpƒõt na Palpatius games</a>

    <div class="container">
        <h1>Virtu√°ln√≠ Zahr√°dka</h1>

        <section aria-labelledby="garden-status-heading">
            <h2 id="garden-status-heading" tabindex="0">Stav zahr√°dky</h2>
            <div class="flex justify-between items-center mb-4">
                <div class="text-lg">Den: <span id="gameDayDisplay">1</span></div>
            </div>

            <div id="gardenGrid" role="grid" aria-label="Hern√≠ pole zahr√°dky">
                </div>
        </section>

        <div id="gameMessages" class="game-messages" aria-live="polite" aria-atomic="false"></div>

        <div class="info-message text-center text-gray-300 mb-4">
            <p><strong>Jak interagovat:</strong></p>
            <p>Kliknƒõte na **pr√°zdn√© pol√≠ƒçko** pro zasazen√≠ sem√≠nka.</p>
            <p>Kliknƒõte na **rostlinu** pro zalit√≠ (s vybranou konv√≠), hnojen√≠ (s vybran√Ωm urychlovaƒçem), sklize≈à (pokud je zral√°) nebo odstranƒõn√≠ ≈°k≈Ødce.</p>
        </div>

        <section aria-labelledby="inventory-heading">
            <h2 id="inventory-heading" tabindex="0">Invent√°≈ô</h2>
            <div class="text-lg mb-4">Zla≈•√°ky: <span id="currencyDisplay">0</span></div>
            <div id="inventoryItems" class="inventory-items">
                </div>
        </section>

        <section aria-labelledby="daily-quests-heading">
            <h2 id="daily-quests-heading" tabindex="0">Denn√≠ √∫koly</h2>
            <div id="dailyQuests" class="shop-section">
                <div id="activeQuestDisplay">
                    </div>
            </div>
        </section>

        <section aria-labelledby="actions-heading">
            <h2 id="actions-heading" tabindex="0">Akce</h2>
            <div class="action-buttons">
                <button class="btn-action" id="nextDayButton" onclick="nextDay()">Dal≈°√≠ den</button>
                <button class="btn-primary" id="waterAllButton" onclick="waterAllPlants()">Zal√≠t v≈°e</button>
                <button class="btn-primary" id="harvestAllButton" onclick="harvestAllRipePlants()">Sklidit v≈°e</button>
                <button class="btn-action" id="shopButton" onclick="showGardenShopModal()">J√≠t do Garden Shopu</button>
                <button class="btn-export" onclick="exportGame()">Exportovat hru (JSON)</button>
                <label class="btn-import">
                    Importovat hru (JSON)
                    <input type="file" id="importGameFile" accept=".json" onchange="importGame(event)" class="hidden" aria-label="Naƒç√≠st hru ze souboru"/>
                </label>
            </div>
        </section>
    </div>

    <div id="customMessageModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalMessageTitle" tabindex="-1">
        <div class="modal-content">
            <h3 id="modalMessageTitle" class="text-xl font-bold text-yellow-300 mb-4">Zpr√°va</h3>
            <p id="modalMessage" class="text-gray-300 mb-4"></p>
            <div class="modal-buttons">
                <button id="modalOkButton" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md">OK</button>
                <button id="modalCancelButton" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md ml-2 hidden">Zru≈°it</button>
            </div>
        </div>
    </div>

    <div id="plantSeedModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="plantSeedModalTitle" tabindex="-1">
        <div class="modal-content">
            <h3 id="plantSeedModalTitle" class="text-xl font-bold text-yellow-300 mb-4">Zasadit sem√≠nko</h3>
            <p class="text-gray-300 mb-4">Vyberte sem√≠nko, kter√© chcete zasadit:</p>
            <div id="seedOptions" class="flex flex-wrap justify-center gap-3 mb-4">
                </div>
            <div class="modal-buttons">
                <button id="cancelPlantingButton" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md">Zru≈°it</button>
            </div>
        </div>
    </div>

    <div id="gardenShopModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="shopModalTitle" tabindex="-1">
        <div class="modal-content max-w-2xl"> <h3 id="shopModalTitle" class="text-xl font-bold text-yellow-300 mb-4">V√≠tej v Garden Shopu!</h3>
            <p class="text-lg text-gray-300 mb-4">Tvoje Zla≈•√°ky: <span id="shopCurrencyDisplay">0</span></p>
            
            <div id="shopContent">
                <div class="shop-section">
                    <h4 class="text-lg font-semibold text-blue-300 mb-3">Prodat plodiny</h4>
                    <div id="sellItemsContainer">
                        </div>
                </div>

                <div class="shop-section">
                    <h4 class="text-lg font-semibold text-green-300 mb-3">Koupit sem√≠nka a n√°stroje</h4>
                    <div id="buyItemsContainer">
                        </div>
                </div>
            </div>

            <div class="modal-buttons mt-6">
                <button id="closeShopButton" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md">Zav≈ô√≠t Shop</button>
            </div>
        </div>
    </div>

    <div id="announcer" class="sr-only" aria-live="polite" aria-atomic="false"></div>

    <script>
        // --- DOM elementy ---
        const gardenGridElement = document.getElementById('gardenGrid');
        const inventoryItemsElement = document.getElementById('inventoryItems');
        const gameDayDisplay = document.getElementById('gameDayDisplay');
        const announcer = document.getElementById('announcer');
        const currencyDisplay = document.getElementById('currencyDisplay');
        const shopCurrencyDisplay = document.getElementById('shopCurrencyDisplay');
        const sellItemsContainer = document.getElementById('sellItemsContainer');
        const buyItemsContainer = document.getElementById('buyItemsContainer');
        const gardenShopModal = document.getElementById('gardenShopModal');
        const closeShopButton = document.getElementById('closeShopButton');
        const plantSeedModal = document.getElementById('plantSeedModal');
        const seedOptionsContainer = document.getElementById('seedOptions');
        const cancelPlantingButton = document.getElementById('cancelPlantingButton');
        const dailyQuestsSection = document.getElementById('dailyQuests');
        const activeQuestDisplay = document.getElementById('activeQuestDisplay');
        const gameMessagesContainer = document.getElementById('gameMessages');
        let currentPlotForPlanting = null;
        let lastActiveElementBeforeModal = null;


        // --- Sjednocen√Ω syst√©m pro mod√°ln√≠ okna a zpr√°vy ---
        window.myoModals = {
            lastFocusedElement: null,
            showCustomModal: function(message, title = 'Zpr√°va', onConfirm = null, showCancel = false) {
                this.lastFocusedElement = document.activeElement;
                const modal = document.getElementById('customMessageModal');
                document.getElementById('modalMessageTitle').textContent = title;
                document.getElementById('modalMessage').innerHTML = message;
                modal.style.display = 'flex';
                
                const okButton = document.getElementById('modalOkButton');
                okButton.onclick = () => { this.closeCustomModal(); if (onConfirm) onConfirm(); };
                
                let cancelButton = document.getElementById('modalCancelButton');
                cancelButton.style.display = showCancel ? 'inline-block' : 'none';
                cancelButton.onclick = () => this.closeCustomModal();
                
                modal.focus();
                modal.setAttribute('aria-hidden', 'false');
            },
            closeCustomModal: function() {
                const modal = document.getElementById('customMessageModal');
                modal.style.display = 'none';
                modal.setAttribute('aria-hidden', 'true');
                if (this.lastFocusedElement) {
                    this.lastFocusedElement.focus();
                }
            },
            closeModal: function(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'none';
                    modal.setAttribute('aria-hidden', 'true');
                    if (this.lastFocusedElement) {
                        this.lastFocusedElement.focus();
                    }
                }
            },
            handleGlobalModalKeyboard: function(event) {
                if (event.key === 'Escape') {
                    const openModals = document.querySelectorAll('.modal[style*="display: flex"]');
                    if (openModals.length > 0) {
                        const topModal = openModals[openModals.length - 1];
                        window.myoModals.closeModal(topModal.id);
                    }
                }
            }
        };

        const ANNOUNCE_DELAY = 100;
        let announceTimeout = null;
        let pendingAnnouncement = null;
        function announceToScreenReader(message) {
            pendingAnnouncement = message;
            if (announceTimeout) return;
            announceTimeout = setTimeout(() => {
                if (pendingAnnouncement && announcer) {
                    announcer.textContent = pendingAnnouncement;
                }
                announceTimeout = null;
                pendingAnnouncement = null;
            }, ANNOUNCE_DELAY);
        }

        const MESSAGE_DURATION = 5000;
        let messageTimeoutRefs = new Set();
        function showGameMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('game-message-item');
            messageDiv.textContent = message;
            gameMessagesContainer.appendChild(messageDiv);
            
            const timeoutId = setTimeout(() => {
                messageDiv.remove();
                messageTimeoutRefs.delete(timeoutId);
            }, MESSAGE_DURATION);
            messageTimeoutRefs.add(timeoutId);
            
            announceToScreenReader(message);
        }

        const GARDEN_SIZE = 32;
        const PEST_CHANCE = 0.20;
        const QUEST_APPEARANCE_CHANCE = 0.30;
        const QUEST_DECLINE_RETURN_DAYS_MIN = 2;
        const QUEST_DECLINE_RETURN_DAYS_MAX = 5;

        const plantsConfig = {
            '≈òedkviƒçky': { emoji: 'üå±', growthStages: [ { name: 'Sem√≠nko', duration: 0 }, { name: 'Kl√≠ƒçek', duration: 1 }, { name: 'Mlad√° rostlinka', duration: 1 }, { name: 'Zral√°', duration: 1 } ], seedYield: 3, sellPrice: 5, buyPrice: 3, seedSellPrice: 1, description: 'Rychle rostouc√≠ a k≈ôupav√© ≈ôedkviƒçky.' },
            'Hl√°vkov√Ω sal√°t': { emoji: 'ü•¨', growthStages: [ { name: 'Sem√≠nko', duration: 0 }, { name: 'Kl√≠ƒçek', duration: 1 }, { name: 'Mlad√° rostlinka', duration: 1 }, { name: 'Zral√Ω', duration: 1 } ], seedYield: 2, sellPrice: 10, buyPrice: 7, seedSellPrice: 3, description: 'Obl√≠ben√Ω hl√°vkov√Ω sal√°t, ide√°ln√≠ do sal√°t≈Ø.' },
            'ƒåerven√° paprika': { emoji: 'üå∂Ô∏è', growthStages: [ { name: 'Sem√≠nko', duration: 0 }, { name: 'Kl√≠ƒçek', duration: 2 }, { name: 'Mlad√° rostlinka', duration: 2 }, { name: 'Zral√°', duration: 2 } ], seedYield: 2, sellPrice: 20, buyPrice: 15, seedSellPrice: 5, description: 'Sladk√° a ≈°≈•avnat√° ƒçerven√° paprika.' },
            'Chilli jalape≈àos': { emoji: 'üå∂Ô∏è', growthStages: [ { name: 'Sem√≠nko', duration: 0 }, { name: 'Kl√≠ƒçek', duration: 2 }, { name: 'Mlad√° rostlinka', duration: 2 }, { name: 'Zral√°', duration: 2 } ], seedYield: 3, sellPrice: 30, buyPrice: 20, seedSellPrice: 8, description: 'P√°liv√© chilli papriƒçky jalape≈àos.' },
            'Jablo≈à': { emoji: 'üçé', growthStages: [ { name: 'Sazenice', duration: 0 }, { name: 'Mlad√Ω stromek', duration: 5 }, { name: 'Plod√≠c√≠', duration: 5 } ], seedYield: 1, sellPrice: 100, buyPrice: 70, seedSellPrice: 20, description: 'Ovocn√Ω strom, kter√Ω plod√≠ sladk√° jablka.' },
            'T≈ôe≈°e≈à': { emoji: 'üçí', growthStages: [ { name: 'Sazenice', duration: 0 }, { name: 'Mlad√Ω stromek', duration: 5 }, { name: 'Plod√≠c√≠', duration: 5 } ], seedYield: 1, sellPrice: 100, buyPrice: 70, seedSellPrice: 20, description: 'Ovocn√Ω strom, kter√Ω plod√≠ ≈°≈•avnat√© t≈ôe≈°nƒõ.' },
            'Hru≈°ka': { emoji: 'üçê', growthStages: [ { name: 'Sazenice', duration: 0 }, { name: 'Mlad√Ω stromek', duration: 5 }, { name: 'Plod√≠c√≠', duration: 5 } ], seedYield: 1, sellPrice: 100, buyPrice: 70, seedSellPrice: 20, description: 'Ovocn√Ω strom, kter√Ω plod√≠ sladk√© hru≈°ky.' },
            'Tulip√°n': { emoji: 'üå∑', growthStages: [ { name: 'Cibulka', duration: 0 }, { name: 'V√Ωhonek', duration: 1 }, { name: 'Kvetouc√≠', duration: 1 } ], seedYield: 1, sellPrice: 20, buyPrice: 15, seedSellPrice: 5, description: 'Kr√°sn√° jarn√≠ kvƒõtina.' },
            'Lilie': { emoji: 'üå∏', growthStages: [ { name: 'Cibulka', duration: 0 }, { name: 'V√Ωhonek', duration: 1 }, { name: 'Kvetouc√≠', duration: 1 } ], seedYield: 1, sellPrice: 20, buyPrice: 15, seedSellPrice: 5, description: 'Elegantn√≠ a vo≈àav√° lilie.' },
            'M√°ta': { emoji: 'üåø', growthStages: [ { name: 'Sazeniƒçka', duration: 0 }, { name: 'Mlad√° bylinka', duration: 1 }, { name: 'Zral√°', duration: 1 } ], seedYield: 5, sellPrice: 5, buyPrice: 3, seedSellPrice: 1, description: 'Osvƒõ≈æuj√≠c√≠ bylinka, ide√°ln√≠ do n√°poj≈Ø.' },
            'Pa≈æitka': { emoji: 'üåø', growthStages: [ { name: 'Sazeniƒçka', duration: 0 }, { name: 'Mlad√° bylinka', duration: 1 }, { name: 'Zral√°', duration: 1 } ], seedYield: 5, sellPrice: 5, buyPrice: 3, seedSellPrice: 1, description: 'Jemn√° bylinka s cibulovou chut√≠.' },
            'Chmel': { emoji: 'üåæ', growthStages: [ { name: 'Sem√≠nko', duration: 0 }, { name: 'V√Ωhonek', duration: 2 }, { name: 'Zral√Ω', duration: 2 } ], seedYield: 2, sellPrice: 25, buyPrice: 10, seedSellPrice: 4, description: 'Z√°kladn√≠ surovina pro v√Ωrobu piva.' },
            'Tymi√°n': { emoji: 'üåø', growthStages: [ { name: 'Sazeniƒçka', duration: 0 }, { name: 'Mlad√° bylinka', duration: 1 }, { name: 'Zral√°', duration: 1 } ], seedYield: 5, sellPrice: 5, buyPrice: 3, seedSellPrice: 1, description: 'Aromatick√° bylinka, skvƒõl√° do kuchynƒõ.' }
        };

        const shopItemsConfig = {
            '≈òedkviƒçky Sem√≠nka': { type: 'seed', price: plantsConfig['≈òedkviƒçky'].buyPrice, emoji: plantsConfig['≈òedkviƒçky'].emoji },
            'Hl√°vkov√Ω sal√°t Sem√≠nka': { type: 'seed', price: plantsConfig['Hl√°vkov√Ω sal√°t'].buyPrice, emoji: plantsConfig['Hl√°vkov√Ω sal√°t'].emoji },
            'ƒåerven√° paprika Sem√≠nka': { type: 'seed', price: plantsConfig['ƒåerven√° paprika'].buyPrice, emoji: plantsConfig['ƒåerven√° paprika'].emoji },
            'Chilli jalape≈àos Sem√≠nka': { type: 'seed', price: plantsConfig['Chilli jalape≈àos'].buyPrice, emoji: plantsConfig['Chilli jalape≈àos'].emoji },
            'Jablo≈à Sazenice': { type: 'seed', price: plantsConfig['Jablo≈à'].buyPrice, emoji: plantsConfig['Jablo≈à'].emoji },
            'T≈ôe≈°e≈à Sazenice': { type: 'seed', price: plantsConfig['T≈ôe≈°e≈à'].buyPrice, emoji: plantsConfig['T≈ôe≈°e≈à'].emoji },
            'Hru≈°ka Sazenice': { type: 'seed', price: plantsConfig['Hru≈°ka'].buyPrice, emoji: plantsConfig['Hru≈°ka'].emoji },
            'Tulip√°n Sem√≠nka': { type: 'seed', price: plantsConfig['Tulip√°n'].buyPrice, emoji: plantsConfig['Tulip√°n'].emoji },
            'Lilie Sem√≠nka': { type: 'seed', price: plantsConfig['Lilie'].buyPrice, emoji: plantsConfig['Lilie'].emoji },
            'M√°ta Sem√≠nka': { type: 'seed', price: plantsConfig['M√°ta'].buyPrice, emoji: plantsConfig['M√°ta'].emoji },
            'Pa≈æitka Sem√≠nka': { type: 'seed', price: plantsConfig['Pa≈æitka'].buyPrice, emoji: plantsConfig['Pa≈æitka'].emoji },
            'Chmel Sem√≠nka': { type: 'seed', price: plantsConfig['Chmel'].buyPrice, emoji: plantsConfig['Chmel'].emoji },
            'Tymi√°n Sem√≠nka': { type: 'seed', price: plantsConfig['Tymi√°n'].buyPrice, emoji: plantsConfig['Tymi√°n'].emoji },
            'Konev na zal√©v√°n√≠': { type: 'tool', price: 50, emoji: 'üíß' },
            'Urychlovaƒç': { type: 'tool', price: 25, emoji: '‚ú®' }
        };

        const questsConfig = {
            'Ond≈ôej Jedl√≠k': { emoji: 'üßë', quests: [ { id: 'ondrej_quest_1', text: 'Pot≈ôebuji 5x ≈òedkviƒçky, 3x Hl√°vkov√Ω sal√°t, 4x Tymi√°n a 2x ƒåerven√° paprika.', requirements: { '≈òedkviƒçky': 5, 'Hl√°vkov√Ω sal√°t': 3, 'Tymi√°n': 4, 'ƒåerven√° paprika': 2 }, rewards: { currency: 120 } }, { id: 'ondrej_quest_2', text: 'M√°m velkou zak√°zku. Pot≈ôebuji 6x ≈òedkviƒçky, 4x Hl√°vkov√Ω sal√°t, 2x Tymi√°n a 5x ƒåerven√° paprika.', requirements: { '≈òedkviƒçky': 6, 'Hl√°vkov√Ω sal√°t': 4, 'Tymi√°n': 2, 'ƒåerven√° paprika': 5 }, rewards: { currency: 150 } } ] },
            'Jana ≈†t√≠hl√°': { emoji: ' ', quests: [ { id: 'jana_quest_1', text: 'Pot≈ôebuji na z√≠t≈ôej≈°√≠ sal√°t 2x Hl√°vkov√Ω sal√°t.', requirements: { 'Hl√°vkov√Ω sal√°t': 2 }, rewards: { currency: 25, '≈òedkviƒçky Sem√≠nka': 1 } }, { id: 'jana_quest_2', text: 'Pot≈ôebuji na z√≠t≈ôej≈°√≠ sal√°t 3x ≈òedkviƒçky.', requirements: { '≈òedkviƒçky': 3 }, rewards: { currency: 20, 'Hl√°vkov√Ω sal√°t Sem√≠nka': 1 } }, { id: 'jana_quest_3', text: 'Doch√°z√≠ mi z√°soby, pot≈ôebuji 10x Hl√°vkov√Ω sal√°t.', requirements: { 'Hl√°vkov√Ω sal√°t': 10 }, rewards: { currency: 90, 'Hl√°vkov√Ω sal√°t Sem√≠nka': 2 } }, { id: 'jana_quest_4', text: 'Prodej mi 12x Hl√°vkov√Ω sal√°t, nemohu se bez nƒõj obej√≠t!', requirements: { 'Hl√°vkov√Ω sal√°t': 12 }, rewards: { currency: 110, 'Urychlovaƒç': 1 } } ] },
            'Radek Piva≈ô': { emoji: 'üë®', quests: [ { id: 'radek_quest_1', text: 'Pot≈ôebuju nutnƒõ 5x Chmel na novou v√°rku piva.', requirements: { 'Chmel': 5 }, rewards: { currency: 100, 'Urychlovaƒç': 1 } }, { id: 'radek_quest_2', text: 'Do≈°el mi chmel. Pot≈ôeboval bych 3x Chmel.', requirements: { 'Chmel': 3 }, rewards: { currency: 60, 'Konev na zal√©v√°n√≠': 1 } }, { id: 'radek_quest_3', text: 'Doch√°z√≠ mi z√°soby. Pot≈ôebuji 3x Tymi√°n, 4x M√°ta a 2x Chilli jalape≈àos.', requirements: { 'Tymi√°n': 3, 'M√°ta': 4, 'Chilli jalape≈àos': 2 }, rewards: { currency: 75, 'Chmel Sem√≠nka': 1 } }, { id: 'radek_quest_4', text: 'Pot≈ôebuji 6x Tymi√°n, 7x M√°ta a 2x Chilli jalape≈àos na speci√°ln√≠ v√°rku!', requirements: { 'Tymi√°n': 6, 'M√°ta': 7, 'Chilli jalape≈àos': 2 }, rewards: { currency: 110, 'Urychlovaƒç': 1 } } ] },
            'Jan Tlou≈°t√≠k': { emoji: 'üßî', quests: [ { id: 'jan_quest_1', text: 'J√≠dlo mi u≈æ bez chilli nechutn√°. Nutnƒõ pot≈ôebuji 10x Chilli jalape≈àos!', requirements: { 'Chilli jalape≈àos': 10 }, rewards: { currency: 250, 'Urychlovaƒç': 1 } }, { id: 'jan_quest_2', text: 'Jalape≈àos nebo ≈æivot! Prodej mi 15x Chilli jalape≈àos?', requirements: { 'Chilli jalape≈àos': 15 }, rewards: { currency: 400, 'Urychlovaƒç': 2 } } ] },
            'Marie Krop√°ƒçov√°': { emoji: 'üëµ', quests: [ { id: 'marie_quest_1', text: 'Vykupuji sem√≠nka! Prodej mi 5x ≈òedkviƒçky Sem√≠nka.', requirements: { '≈òedkviƒçky Sem√≠nka': 5 }, rewards: { currency: 10 } }, { id: 'marie_quest_2', text: 'Pot≈ôebuji tolik sem√≠nek, kolik jen m≈Ø≈æe≈° prodat! M≈Ø≈æe≈° mi prodat 3x Hl√°vkov√Ω sal√°t Sem√≠nka a 3x ƒåerven√° paprika Sem√≠nka?', requirements: { 'Hl√°vkov√Ω sal√°t Sem√≠nka': 3, 'ƒåerven√° paprika Sem√≠nka': 3 }, rewards: { currency: 30 } } ] }
        };
        
        let game = {
            day: 1,
            garden: Array(GARDEN_SIZE).fill(null).map(() => ({ plant: null, watered: false, hasPest: false })),
            inventory: {
                '≈òedkviƒçky Sem√≠nka': 3, 'Hl√°vkov√Ω sal√°t Sem√≠nka': 3, 'ƒåerven√° paprika Sem√≠nka': 3,
                'Chilli jalape≈àos Sem√≠nka': 3, 'Tymi√°n Sem√≠nka': 3, 'Konev na zal√©v√°n√≠': 1, 'Urychlovaƒç': 0
            },
            currency: 50,
            selectedItem: null,
            activeQuest: null,
            lastQuestCheckDay: 0
        };
        
        let actionLock = false;
        const DEBOUNCE_DELAY = 100;
        let debounceTimer = null;
        function debounce(func, delay) {
            return function(...args) {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        }

        function initializeGame() {
            try {
                renderAll();
                announceToScreenReader(`V√≠tejte na zahr√°dce! Dnes je den ${game.day}.`);
                checkAndGenerateQuest();
            } catch (error) {
                console.error('Chyba p≈ôi inicializaci hry:', error);
                myoModals.showCustomModal('Nastala chyba p≈ôi inicializaci hry.', 'Chyba');
            }
        }
        
        let renderTimeout = null;
        const RENDER_DELAY = 50;
        function renderAll(focusedElement = null) {
            if (renderTimeout) return;
            renderTimeout = setTimeout(() => {
                try {
                    const currentFocusedIndex = focusedElement ? parseInt(focusedElement.dataset.index) : null;
                    const currentFocusedItem = focusedElement ? focusedElement.dataset.item : null;
                    const currentFocusedId = focusedElement ? focusedElement.id : null;

                    renderGarden();
                    renderInventory();
                    gameDayDisplay.textContent = game.day;
                    currencyDisplay.textContent = game.currency; 
                    if (shopCurrencyDisplay) shopCurrencyDisplay.textContent = game.currency;
                    displayActiveQuest();
                    
                    if (currentFocusedIndex !== null) {
                        const newFocusedElement = document.querySelector(`.plot[data-index="${currentFocusedIndex}"]`);
                        if (newFocusedElement) newFocusedElement.focus();
                    } else if (currentFocusedItem) {
                        const newFocusedElement = document.querySelector(`.inventory-item[data-item="${currentFocusedItem}"]`);
                        if (newFocusedElement) newFocusedElement.focus();
                    } else if(currentFocusedId) {
                        const newFocusedElement = document.getElementById(currentFocusedId);
                        if(newFocusedElement) newFocusedElement.focus();
                    }
                } catch (error) {
                    console.error('Chyba p≈ôi renderov√°n√≠:', error);
                    myoModals.showCustomModal('Nastala chyba p≈ôi aktualizaci hry.', 'Chyba');
                } finally {
                    renderTimeout = null;
                }
            }, RENDER_DELAY);
        }

        function updatePlotElement(plotDiv, plotData, index) {
            try {
                const PEST_EMOJI = 'üêõ';
                if (plotData.plant) {
                    const plantType = plotData.plant.type;
                    const plantConfig = plantsConfig[plantType];
                    const currentStage = plantConfig.growthStages[plotData.plant.stage];

                    let statusText = currentStage.name;
                    let statusClass = '';
                    let ariaLabel = `${plantType} (${currentStage.name})`;
                    
                    plotDiv.innerHTML = `<span class="plant-icon">${plantConfig.emoji}</span>`;

                    if (plotData.hasPest) {
                        plotDiv.innerHTML = `<span class="pest-icon">${PEST_EMOJI}</span>` + plotDiv.innerHTML;
                        statusText = '≈†k≈Ødce!';
                        statusClass = 'pest';
                        ariaLabel += `, napadena ≈°k≈Ødcem.`;
                    } else if (plotData.plant.stage === plantConfig.growthStages.length - 1) {
                        statusText = 'Zral√°!';
                        statusClass = 'ready';
                        ariaLabel += `, zral√°.`;
                    } else if (!plotData.watered) {
                        statusText += ' (Sucho)';
                        statusClass = 'dry';
                        ariaLabel += `, sucho.`;
                    } else {
                        statusText += ' (Zalito)';
                        statusClass = 'watered';
                        ariaLabel += `, zalito.`;
                    }
                    plotDiv.innerHTML += `<span class="plant-status ${statusClass}">${statusText}</span>`;
                    plotDiv.setAttribute('aria-label', ariaLabel);
                } else {
                    plotDiv.innerHTML = '‚ûï';
                    plotDiv.setAttribute('aria-label', `Pr√°zdn√© pol√≠ƒçko.`);
                }
            } catch (error) {
                console.error('Chyba p≈ôi aktualizaci pol√≠ƒçka:', error);
                plotDiv.innerHTML = 'Error';
                plotDiv.setAttribute('aria-label', `Chyba p≈ôi naƒç√≠t√°n√≠ pol√≠ƒçka ${index + 1}.`);
            }
        }

        function renderGarden() {
            const currentPlots = gardenGridElement.querySelectorAll('.plot');
            if (currentPlots.length !== game.garden.length) {
                gardenGridElement.innerHTML = '';
                game.garden.forEach((plotData, index) => {
                    const plotDiv = document.createElement('div');
                    plotDiv.classList.add('plot');
                    plotDiv.setAttribute('tabindex', '0');
                    plotDiv.setAttribute('role', 'gridcell');
                    plotDiv.dataset.index = index;
                    updatePlotElement(plotDiv, plotData, index);
                    gardenGridElement.appendChild(plotDiv);
                });
            } else {
                currentPlots.forEach((plotDiv, index) => {
                    updatePlotElement(plotDiv, game.garden[index], index);
                });
            }
        }
        
        gardenGridElement.addEventListener('click', (e) => {
            const plot = e.target.closest('.plot');
            if(plot) {
                const index = parseInt(plot.dataset.index);
                handlePlotClick(index);
            }
        });

        function renderInventory() {
            inventoryItemsElement.innerHTML = '';
            for (const item in game.inventory) {
                if (game.inventory[item] > 0 || item === 'Konev na zal√©v√°n√≠') { 
                    const itemDiv = document.createElement('div');
                    itemDiv.classList.add('inventory-item');
                    itemDiv.setAttribute('tabindex', '0');
                    itemDiv.setAttribute('role', 'button');
                    itemDiv.setAttribute('aria-label', `Polo≈æka invent√°≈ôe: ${item}, mno≈æstv√≠ ${game.inventory[item]}.`);
                    itemDiv.dataset.item = item;
                    itemDiv.textContent = `${item}: ${game.inventory[item]}`;
                    if (game.selectedItem === item) itemDiv.classList.add('selected');
                    inventoryItemsElement.appendChild(itemDiv);
                }
            }
        }

        inventoryItemsElement.addEventListener('click', (e) => {
            const itemDiv = e.target.closest('.inventory-item');
            if(itemDiv) {
                const item = itemDiv.dataset.item;
                selectInventoryItem(item);
            }
        });

        function selectInventoryItem(item) {
            try {
                const focusedElement = document.activeElement;
                if (game.selectedItem === item) {
                    game.selectedItem = null;
                    showGameMessage(`${item} odznaƒçeno.`);
                } else {
                    game.selectedItem = item;
                    showGameMessage(`${item} vybr√°no.`);
                }
                renderAll(focusedElement);
            } catch (error) {
                console.error('Chyba p≈ôi v√Ωbƒõru polo≈æky:', error);
                myoModals.showCustomModal('Nastala chyba p≈ôi v√Ωbƒõru polo≈æky.', 'Chyba');
            }
        }
        
        function handlePlotClick(index) {
            try {
                const plot = game.garden[index];
                const focusedElement = document.activeElement;
                
                if (plot.plant) {
                    if (plot.hasPest) {
                        plot.hasPest = false;
                        showGameMessage(`Odstranil jsi ≈°k≈Ødce.`);
                    } else if (game.selectedItem === 'Konev na zal√©v√°n√≠') {
                        performAction('water', index);
                    } else if (game.selectedItem === 'Urychlovaƒç') {
                        performAction('fertilize', index);
                    } else if (plot.plant.stage === plantsConfig[plot.plant.type].growthStages.length - 1) {
                        performAction('harvest', index);
                    } else {
                        showGameMessage(`${plot.plant.type} je ve f√°zi ${plantsConfig[plot.plant.type].growthStages[plot.plant.stage].name}.`);
                    }
                } else {
                    showPlantSeedModal(index);
                }
                renderAll(focusedElement);
            } catch (error) {
                console.error('Chyba p≈ôi interakci s pol√≠ƒçkem:', error);
                myoModals.showCustomModal('Nastala chyba p≈ôi interakci s pol√≠ƒçkem.', 'Chyba');
            }
        }
        
        function showPlantSeedModal(plotIndex) {
            try {
                currentPlotForPlanting = plotIndex;
                myoModals.lastFocusedElement = document.activeElement;
                seedOptionsContainer.innerHTML = '';
                let hasSeeds = false;
                for (const item in game.inventory) {
                    if (item.endsWith('Sem√≠nka') && game.inventory[item] > 0) {
                        hasSeeds = true;
                        const plantType = item.replace(' Sem√≠nka', '');
                        const button = document.createElement('button');
                        button.classList.add('btn-action', 'px-4', 'py-2', 'rounded-md');
                        button.textContent = `${plantType} (${game.inventory[item]})`;
                        button.setAttribute('aria-label', `Zasadit ${plantType} sem√≠nko.`);
                        button.onclick = () => plantSeed(plotIndex, plantType);
                        seedOptionsContainer.appendChild(button);
                    }
                }
                if (!hasSeeds) {
                    seedOptionsContainer.innerHTML = '<p class="text-gray-400">Nem√°te ≈æ√°dn√° sem√≠nka k zasazen√≠.</p>';
                }
                plantSeedModal.style.display = 'flex';
                plantSeedModal.focus();
                announceToScreenReader('Vyberte sem√≠nko k zasazen√≠.');
            } catch (error) {
                console.error('Chyba p≈ôi otev√≠r√°n√≠ modal okna pro s√°zen√≠:', error);
                myoModals.showCustomModal('Nastala chyba p≈ôi otev√≠r√°n√≠ modal okna.', 'Chyba');
            }
        }

        function plantSeed(plotIndex, plantType) {
            try {
                const seedItemName = `${plantType} Sem√≠nka`;
                if (game.inventory[seedItemName] && game.inventory[seedItemName] > 0) {
                    game.garden[plotIndex] = {
                        plant: {
                            type: plantType,
                            stage: 0,
                            dayEnteredStage: game.day
                        },
                        watered: false,
                        hasPest: false
                    };
                    game.inventory[seedItemName]--;
                    showGameMessage(`Zasadil jsi ${plantType}.`);
                } else {
                    myoModals.showCustomModal('Nem√°≈° dostatek sem√≠nek!', 'Chyba');
                }
                myoModals.closeModal('plantSeedModal');
                renderAll(myoModals.lastFocusedElement);
            } catch (error) {
                console.error('Chyba p≈ôi s√°zen√≠ sem√≠nka:', error);
                myoModals.showCustomModal('Nastala chyba p≈ôi s√°zen√≠ sem√≠nka.', 'Chyba');
            }
        }
        cancelPlantingButton.onclick = () => {
            myoModals.closeModal('plantSeedModal');
            if(myoModals.lastFocusedElement) myoModals.lastFocusedElement.focus();
        };

        function performAction(action, plotIndex) {
            try {
                const plot = game.garden[plotIndex];
                if (!plot || !plot.plant) {
                    if (action === 'fertilize') {
                        myoModals.showCustomModal('Nelze pou≈æ√≠t urychlovaƒç na pr√°zdn√© pol√≠ƒçko!', 'Chyba');
                    }
                    return;
                }
                const focusedElement = document.activeElement;

                if (action === 'water') {
                    if (game.inventory['Konev na zal√©v√°n√≠'] <= 0) {
                        myoModals.showCustomModal('Nem√°≈° konev na zal√©v√°n√≠! Kup si ji v obchodƒõ.', 'Chyba');
                        return;
                    }
                    if (plot.watered) {
                        showGameMessage(`Rostlina u≈æ je zalit√°.`);
                        return;
                    }
                    plot.watered = true;
                    showGameMessage(`Zalil jsi rostlinu.`);
                } else if (action === 'harvest') {
                    const plantType = plot.plant.type;
                    const plantConfig = plantsConfig[plantType];
                    if (plot.plant.stage !== plantConfig.growthStages.length - 1) {
                        showGameMessage(`Rostlina nen√≠ zral√° ke sklizni.`);
                        return;
                    }
                    const harvestedItem = plantType;
                    game.inventory[harvestedItem] = (game.inventory[harvestedItem] || 0) + 1;
                    showGameMessage(`Sklidil jsi ${harvestedItem}.`);

                    const seedItemName = `${plantType} Sem√≠nka`;
                    game.inventory[seedItemName] = (game.inventory[seedItemName] || 0) + plantConfig.seedYield;
                    showGameMessage(`Z√≠skal jsi ${plantConfig.seedYield} sem√≠nek.`);

                    game.garden[plotIndex] = { plant: null, watered: false, hasPest: false };
                } else if (action === 'fertilize') {
                    if (game.inventory['Urychlovaƒç'] <= 0) {
                        myoModals.showCustomModal('Nem√°≈° ≈æ√°dn√Ω Urychlovaƒç!', 'Chyba');
                        return;
                    }
                    const plantType = plot.plant.type;
                    const plantConfig = plantsConfig[plantType];
                    if (plot.plant.stage < plantConfig.growthStages.length - 1) {
                        plot.plant.stage++;
                        plot.plant.dayEnteredStage = game.day;
                        game.inventory['Urychlovaƒç']--;
                        showGameMessage(`Pou≈æil jsi Urychlovaƒç. Rostlina postoupila do dal≈°√≠ f√°ze!`);
                    } else {
                        myoModals.showCustomModal(`${plantType} u≈æ je v posledn√≠ f√°zi r≈Østu, nelze pou≈æ√≠t Urychlovaƒç.`, 'Nelze urychlit');
                    }
                }
                renderAll(focusedElement);
            } catch (error) {
                console.error('Chyba p≈ôi prov√°dƒõn√≠ akce:', error);
                myoModals.showCustomModal('Nastala neoƒçek√°van√° chyba.', 'Chyba');
            }
        }

        function nextDay() {
            try {
                const focusedElement = document.activeElement;
                game.day++;
                announceToScreenReader(`Zaƒçal den ${game.day}.`);

                const destroyedPlants = [];
                for(let plot of game.garden) {
                    if (plot.plant) {
                        if (plot.hasPest) {
                            destroyedPlants.push(plot.plant.type);
                            plot.plant = null;
                            plot.watered = false;
                            plot.hasPest = false;
                            continue;
                        }
                        const plantType = plot.plant.type;
                        const plantConfig = plantsConfig[plantType];
                        if (plot.plant.stage < plantConfig.growthStages.length - 1) {
                            const daysInCurrentStage = game.day - plot.plant.dayEnteredStage;
                            const requiredDuration = plantConfig.growthStages[plot.plant.stage].duration;
                            if (plot.watered && daysInCurrentStage >= requiredDuration) {
                                plot.plant.stage++;
                                plot.plant.dayEnteredStage = game.day;
                            }
                        }
                        plot.watered = false;
                    }
                }

                if (destroyedPlants.length > 0) {
                    myoModals.showCustomModal(`≈†k≈Ødci zniƒçili tyto rostliny: ${destroyedPlants.join(', ')}.`, 'Rostlina zniƒçena');
                    announceToScreenReader('Nƒõkter√© rostliny byly zniƒçeny ≈°k≈Ødci.');
                }

                const PEST_EMOJI = 'üêõ';
                const PEST_CHANCE = 0.20;
                const availablePlotsForPest = game.garden.filter(p => p.plant && !p.hasPest && p.plant.stage < plantsConfig[p.plant.type].growthStages.length - 1);
                if (availablePlotsForPest.length > 0 && Math.random() < PEST_CHANCE) {
                    const randomPlot = availablePlotsForPest[Math.floor(Math.random() * availablePlotsForPest.length)];
                    const plotIndex = game.garden.indexOf(randomPlot);
                    game.garden[plotIndex].hasPest = true;
                    myoModals.showCustomModal(`Na pol√≠ƒçku ${plotIndex + 1} se objevil ≈°k≈Ødce!`, 'Pozor: ≈†k≈Ødce!');
                    announceToScreenReader(`Na pol√≠ƒçku ${plotIndex + 1} se objevil ≈°k≈Ødce!`);
                }

                checkAndGenerateQuest();
                renderAll(focusedElement);
            } catch (error) {
                console.error('Chyba p≈ôi p≈ôechodu na dal≈°√≠ den:', error);
                myoModals.showCustomModal('Nastala neoƒçek√°van√° chyba.', 'Chyba');
            }
        }
        
        function waterAllPlants() {
            try {
                if (game.inventory['Konev na zal√©v√°n√≠'] <= 0) {
                    myoModals.showCustomModal('Nem√°≈° konev na zal√©v√°n√≠! Kup si ji v obchodƒõ.', 'Chyba');
                    return;
                }
                const focusedElement = document.activeElement;
                let wateredCount = 0;
                game.garden.forEach((plot) => {
                    if (plot.plant && !plot.watered && !plot.hasPest) {
                        plot.watered = true;
                        wateredCount++;
                    }
                });
                if (wateredCount > 0) {
                    showGameMessage(`Zalil jsi ${wateredCount} rostlin.`);
                } else {
                    showGameMessage('≈Ω√°dn√© rostliny nepot≈ôebuj√≠ zal√≠t.');
                }
                renderAll(focusedElement);
            } catch (error) {
                console.error('Chyba p≈ôi zal√©v√°n√≠:', error);
                myoModals.showCustomModal('Nastala neoƒçek√°van√° chyba.', 'Chyba');
            }
        }
        
        function harvestAllRipePlants() {
            try {
                let harvestedCount = 0;
                const focusedElement = document.activeElement;
                game.garden.forEach((plot, index) => {
                    if (plot.plant && plot.plant.stage === plantsConfig[plot.plant.type].growthStages.length - 1) {
                        const plantType = plot.plant.type;
                        const plantConfig = plantsConfig[plantType];
                        game.inventory[plantType] = (game.inventory[plantType] || 0) + 1;
                        const seedItemName = `${plantType} Sem√≠nka`;
                        game.inventory[seedItemName] = (game.inventory[seedItemName] || 0) + plantConfig.seedYield;
                        game.garden[index] = { plant: null, watered: false, hasPest: false };
                        harvestedCount++;
                    }
                });
                if (harvestedCount > 0) {
                    showGameMessage(`Sklidil jsi ${harvestedCount} rostlin.`);
                } else {
                    showGameMessage('≈Ω√°dn√© rostliny nejsou zral√© ke sklizni.');
                }
                renderAll(focusedElement);
            } catch (error) {
                console.error('Chyba p≈ôi sklizni:', error);
                myoModals.showCustomModal('Nastala neoƒçek√°van√° chyba.', 'Chyba');
            }
        }
        
        function exportGame() {
            myoModals.lastFocusedElement = document.activeElement;
            try {
                const dataStr = JSON.stringify(game, null, 2);
                const dl = document.createElement('a');
                dl.setAttribute("href", "data:text/json;charset=utf-8," + encodeURIComponent(dataStr));
                dl.setAttribute("download", `zahrada_save_${game.day}.json`);
                dl.click();
                myoModals.showCustomModal("Stav zahr√°dky byl √∫spƒõ≈°nƒõ exportov√°n.", "Ulo≈æeno");
            } catch (error) {
                console.error("Chyba p≈ôi exportu:", error);
                myoModals.showCustomModal("Nastala chyba p≈ôi exportu. Zkuste to pros√≠m znovu.", 'Chyba exportu');
            }
        }

        function importGame(event) {
            myoModals.lastFocusedElement = document.activeElement;
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const importedGame = JSON.parse(e.target.result);
                    if (validateGameState(importedGame)) {
                        Object.assign(game, importedGame);
                        renderAll(myoModals.lastFocusedElement);
                        myoModals.showCustomModal("Stav zahr√°dky byl √∫spƒõ≈°nƒõ importov√°n.", "Naƒçteno");
                    } else {
                        myoModals.showCustomModal("Chyba: Importovan√Ω soubor nem√° oƒçek√°van√Ω form√°t hry.", 'Chyba importu');
                    }
                } catch (error) {
                    console.error("Chyba p≈ôi importu:", error);
                    myoModals.showCustomModal("Chyba p≈ôi naƒç√≠t√°n√≠ souboru: " + error.message, 'Chyba importu');
                }
            };
            reader.readAsText(file);
        }

        function validateGameState(importedGame) {
            return (
                importedGame && typeof importedGame.day === 'number' && importedGame.day >= 1 &&
                Array.isArray(importedGame.garden) && importedGame.garden.length === GARDEN_SIZE &&
                typeof importedGame.currency === 'number' && importedGame.currency >= 0
            );
        }

        const sectionHeadings = [];
        function populateSectionHeadings() {
            sectionHeadings.length = 0;
            const mainTitle = document.querySelector('h1');
            const gardenStatusHeading = document.getElementById('garden-status-heading');
            const inventoryHeading = document.getElementById('inventory-heading');
            const dailyQuestsHeading = document.getElementById('daily-quests-heading');
            const actionsHeading = document.getElementById('actions-heading');
            if (mainTitle) sectionHeadings.push(mainTitle);
            if (gardenStatusHeading) sectionHeadings.push(gardenStatusHeading);
            if (inventoryHeading) sectionHeadings.push(inventoryHeading);
            if (dailyQuestsHeading && dailyQuestsSection.style.display !== 'none') sectionHeadings.push(dailyQuestsHeading);
            if (actionsHeading) sectionHeadings.push(actionsHeading);
        }

        function jumpToNextSection() {
            if (sectionHeadings.length === 0) return;
            const focusedHeadingIndex = sectionHeadings.indexOf(document.activeElement);
            let currentSectionIndex = (focusedHeadingIndex + 1) % sectionHeadings.length;
            sectionHeadings[currentSectionIndex].focus();
            announceToScreenReader(`P≈ôesunuto na sekci: ${sectionHeadings[currentSectionIndex].textContent}`);
        }

        function moveFocusInGrid(currentIndex, key) {
            const plots = Array.from(gardenGridElement.querySelectorAll('.plot'));
            const numPlots = plots.length;
            let nextIndex = currentIndex;
            const plotsPerRow = Math.floor(gardenGridElement.clientWidth / (plots[0].offsetWidth + parseFloat(window.getComputedStyle(gardenGridElement).gap)));
            
            if (key === 'ArrowUp') nextIndex -= plotsPerRow;
            else if (key === 'ArrowDown') nextIndex += plotsPerRow;
            else if (key === 'ArrowLeft') nextIndex--;
            else if (key === 'ArrowRight') nextIndex++;

            if (nextIndex < 0) nextIndex = 0;
            if (nextIndex >= numPlots) nextIndex = numPlots - 1;

            const nextPlot = document.querySelector(`.plot[data-index="${nextIndex}"]`);
            if (nextPlot) {
                nextPlot.focus();
                announceToScreenReader(nextPlot.getAttribute('aria-label'));
            }
        }

        function moveFocusInInventory(currentItem, key) {
            const inventoryItems = Array.from(document.querySelectorAll('.inventory-item'));
            const currentIndex = inventoryItems.findIndex(item => item.dataset.item === currentItem);
            if (currentIndex === -1) return;

            let nextIndex = currentIndex;
            if (key === 'ArrowLeft') nextIndex--;
            else if (key === 'ArrowRight') nextIndex++;

            if (nextIndex < 0) nextIndex = inventoryItems.length - 1;
            if (nextIndex >= inventoryItems.length) nextIndex = 0;

            if (inventoryItems[nextIndex]) {
                inventoryItems[nextIndex].focus();
                announceToScreenReader(inventoryItems[nextIndex].getAttribute('aria-label'));
            }
        }
        
        inventoryItemsElement.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                selectInventoryItem(e.target.dataset.item);
            } else if (['ArrowLeft', 'ArrowRight'].includes(e.key)) {
                e.preventDefault();
                moveFocusInInventory(e.target.dataset.item, e.key);
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'h' || e.key === 'H') {
                e.preventDefault();
                jumpToNextSection();
            }
        });

        function showGardenShopModal() {
            myoModals.lastFocusedElement = document.activeElement;
            gardenShopModal.style.display = 'flex';
            gardenShopModal.focus();
            gardenShopModal.setAttribute('aria-hidden', 'false');

            shopCurrencyDisplay.textContent = game.currency;
            renderShopSellSection();
            renderShopBuySection();
            const firstInteractiveElement = gardenShopModal.querySelector('input, button');
            if(firstInteractiveElement) firstInteractiveElement.focus();
        }

        function closeGardenShopModal() {
            gardenShopModal.style.display = 'none';
            gardenShopModal.setAttribute('aria-hidden', 'true');
            if (myoModals.lastFocusedElement) {
                myoModals.lastFocusedElement.focus();
            }
        }

        function renderShopSellSection() {
            sellItemsContainer.innerHTML = '';
            let hasSellableItems = false;
            for (const item in game.inventory) {
                const isPlant = plantsConfig[item];
                const isSeed = item.endsWith('Sem√≠nka') && plantsConfig[item.replace(' Sem√≠nka', '')];
                
                if (game.inventory[item] > 0 && (isPlant || isSeed)) {
                    hasSellableItems = true;
                    let displayPrice;
                    let itemDisplayName = item;

                    if (isPlant) {
                        displayPrice = plantsConfig[item].sellPrice;
                    } else if (isSeed) {
                        const plantType = item.replace(' Sem√≠nka', '');
                        displayPrice = plantsConfig[plantType].seedSellPrice;
                    } else {
                        continue; 
                    }

                    const itemDiv = document.createElement('div');
                    itemDiv.classList.add('shop-item');
                    itemDiv.innerHTML = `
                        <div class="shop-item-info">
                            ${itemDisplayName} (${game.inventory[item]} ks) - ${displayPrice} Zla≈•√°k≈Ø/ks
                        </div>
                        <div class="shop-item-controls">
                            <input type="number" min="1" max="${game.inventory[item]}" value="${game.inventory[item]}" id="sell-qty-${item.replace(/\s/g, '-')}" aria-label="Mno≈æstv√≠ k prodeji ${item}">
                            <button class="btn-primary" onclick="sellItem('${item}')">Prodat</button>
                        </div>
                    `;
                    sellItemsContainer.appendChild(itemDiv);
                }
            }
            if (!hasSellableItems) {
                sellItemsContainer.innerHTML = '<p class="text-gray-400">Nem√°≈° ≈æ√°dn√© plodiny ani sem√≠nka k prodeji.</p>';
            }
        }

        function sellItem(itemType) {
            try {
                const quantityInput = document.getElementById(`sell-qty-${itemType.replace(/\s/g, '-')}`);
                let quantityToSell = Math.max(1, Math.min(parseInt(quantityInput.value) || 1, game.inventory[itemType]));

                if (quantityToSell <= 0 || quantityToSell > game.inventory[itemType]) {
                    myoModals.showCustomModal(`Zadej pros√≠m platn√© mno≈æstv√≠ k prodeji.`, 'Chyba prodeje');
                    return;
                }

                let earnedCurrency;
                const isPlant = plantsConfig[itemType];
                const isSeed = itemType.endsWith('Sem√≠nka') && plantsConfig[itemType.replace(' Sem√≠nka', '')];

                if (isPlant) {
                    earnedCurrency = quantityToSell * plantsConfig[itemType].sellPrice;
                } else if (isSeed) {
                    const plantType = itemType.replace(' Sem√≠nka', '');
                    earnedCurrency = quantityToSell * plantsConfig[plantType].seedSellPrice;
                } else {
                    myoModals.showCustomModal(`Nelze prodat polo≈æku ${itemType}.`, 'Chyba prodeje');
                    return;
                }

                game.inventory[itemType] -= quantityToSell;
                game.currency += earnedCurrency;
                showGameMessage(`Prod√°no ${quantityToSell} ${itemType} za ${earnedCurrency} Zla≈•√°k≈Ø.`);
                renderAll(document.activeElement);
            } catch (error) {
                console.error('Chyba p≈ôi prodeji:', error);
                myoModals.showCustomModal('Nastala chyba p≈ôi prodeji. Zkuste to pros√≠m znovu.', 'Chyba prodeje');
            }
        }

        function renderShopBuySection() {
            buyItemsContainer.innerHTML = '';
            let hasBuyableItems = false;
            for (const item in shopItemsConfig) {
                const itemConfig = shopItemsConfig[item];
                hasBuyableItems = true;
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('shop-item');
                itemDiv.innerHTML = `
                    <div class="shop-item-info">
                        ${itemConfig.emoji} ${item} - ${itemConfig.price} Zla≈•√°k≈Ø
                    </div>
                    <div class="shop-item-controls">
                        <input type="number" min="1" value="1" id="buy-qty-${item.replace(/\s/g, '-')}" aria-label="Mno≈æstv√≠ k n√°kupu ${item}">
                        <button class="btn-primary" onclick="buyItem('${item}')">Koupit</button>
                    </div>
                `;
                buyItemsContainer.appendChild(itemDiv);
            }
            if (!hasBuyableItems) {
                buyItemsContainer.innerHTML = '<p class="text-gray-400">Moment√°lnƒõ nic na prodej.</p>';
            }
        }

        function buyItem(itemType) {
            try {
                const itemConfig = shopItemsConfig[itemType];
                if (!itemConfig) return;
                const quantityInput = document.getElementById(`buy-qty-${itemType.replace(/\s/g, '-')}`);
                let quantityToBuy = Math.max(1, parseInt(quantityInput.value) || 1);
                const totalCost = quantityToBuy * itemConfig.price;
                if (game.currency < totalCost) {
                    myoModals.showCustomModal(`Nem√°≈° dostatek Zla≈•√°k≈Ø pro n√°kup ${quantityToBuy} ks ${itemType}! Pot≈ôebuje≈° ${totalCost} Zla≈•√°k≈Ø.`, 'Nem√°≈° dost penƒõz');
                    return;
                }
                game.currency -= totalCost;
                game.inventory[itemType] = (game.inventory[itemType] || 0) + quantityToBuy;
                showGameMessage(`Koupil jsi ${quantityToBuy} ks ${itemType} za ${totalCost} Zla≈•√°k≈Ø.`);
                renderAll(document.activeElement);
            } catch (error) {
                console.error('Chyba p≈ôi n√°kupu:', error);
                myoModals.showCustomModal('Nastala chyba p≈ôi n√°kupu. Zkuste to pros√≠m znovu.', 'Chyba');
            }
        }

        closeShopButton.onclick = () => closeGardenShopModal();

        function checkAndGenerateQuest() {
            if (game.activeQuest && game.activeQuest.returnDay && game.activeQuest.returnDay > game.day) {
                dailyQuestsSection.style.display = 'none';
                return;
            }
            if (game.activeQuest && (!game.activeQuest.returnDay || game.activeQuest.returnDay <= game.day)) {
                game.activeQuest.returnDay = null;
                displayActiveQuest();
                return;
            }
            const PEST_CHANCE = 0.20;
            const QUEST_APPEARANCE_CHANCE = 0.30;
            if (!game.activeQuest && Math.random() < QUEST_APPEARANCE_CHANCE) {
                const npcNames = Object.keys(questsConfig);
                const randomNpcName = npcNames[Math.floor(Math.random() * npcNames.length)];
                const npcConfig = questsConfig[randomNpcName];
                const randomQuest = npcConfig.quests[Math.floor(Math.random() * npcConfig.quests.length)];

                game.activeQuest = {
                    npc: randomNpcName,
                    questId: randomQuest.id,
                    text: randomQuest.text,
                    requirements: randomQuest.requirements,
                    rewards: randomQuest.rewards,
                    returnDay: null
                };
                myoModals.showCustomModal(`Na pol√≠ƒçku ${randomNpcName} se objevil s nov√Ωm √∫kolem!`, 'Nov√Ω √∫kol!');
                announceToScreenReader(`Na pol√≠ƒçku ${randomNpcName} se objevil s nov√Ωm √∫kolem!`);
                displayActiveQuest();
            } else if (!game.activeQuest) {
                dailyQuestsSection.style.display = 'none';
            }
        }

        function displayActiveQuest() {
            if (!game.activeQuest) {
                dailyQuestsSection.style.display = 'none';
                return;
            }
            if (game.activeQuest.returnDay && game.activeQuest.returnDay > game.day) {
                dailyQuestsSection.style.display = 'none';
                return;
            }
            dailyQuestsSection.style.display = 'block';
            activeQuestDisplay.innerHTML = `
                <h4>${questsConfig[game.activeQuest.npc].emoji} ${game.activeQuest.npc} m√° pro tebe √∫kol!</h4>
                <p class="quest-description">${game.activeQuest.text}</p>
                <p class="quest-requirements">Pot≈ôebuje: <span>${formatRequirements(game.activeQuest.requirements)}</span></p>
                <p class="quest-rewards">Nab√≠z√≠: <span>${formatRewards(game.activeQuest.rewards)}</span></p>
                <div class="quest-buttons">
                    <button class="btn-primary" onclick="acceptQuest()">P≈ôijmout</button>
                    <button class="btn-danger" onclick="declineQuest()">Odm√≠tnout</button>
                </div>
            `;
            const dailyQuestsHeading = document.getElementById('daily-quests-heading');
            if(dailyQuestsHeading) {
                dailyQuestsHeading.focus();
            }
        }

        function formatRequirements(requirements) {
            let reqs = [];
            for (const item in requirements) {
                reqs.push(`${requirements[item]}x ${item}`);
            }
            return reqs.join(', ');
        }

        function formatRewards(rewards) {
            let rews = [];
            for (const item in rewards) {
                if (item === 'currency') {
                    rews.push(`${rewards[item]} Zla≈•√°k≈Ø`);
                } else {
                    rews.push(`${rewards[item]}x ${item}`);
                }
            }
            return rews.join(', ');
        }

        function acceptQuest() {
            try {
                const requirements = game.activeQuest.requirements;
                let canFulfill = true;
                let missingItems = [];
                for (const item in requirements) {
                    if ((game.inventory[item] || 0) < requirements[item]) {
                        canFulfill = false;
                        missingItems.push(`${requirements[item]}x ${item}`);
                    }
                }
                if (canFulfill) {
                    for (const item in requirements) {
                        game.inventory[item] -= requirements[item];
                    }
                    const rewards = game.activeQuest.rewards;
                    for (const item in rewards) {
                        if (item === 'currency') {
                            game.currency += rewards[item];
                        } else {
                            game.inventory[item] = (game.inventory[item] || 0) + rewards[item];
                        }
                    }
                    myoModals.showCustomModal(`√ökol od ${game.activeQuest.npc} splnƒõn! Z√≠skal jsi: ${formatRewards(rewards)}.`, '√ökol splnƒõn!');
                    announceToScreenReader(`√ökol splnƒõn. Z√≠skal jsi ${formatRewards(rewards)}.`);
                    game.activeQuest = null;
                } else {
                    myoModals.showCustomModal(`Nem√°≈° dostatek pot≈ôebn√Ωch p≈ôedmƒõt≈Ø pro splnƒõn√≠ √∫kolu! Chyb√≠ ti: ${missingItems.join(', ')}.`, '√ökol nelze splnit');
                    announceToScreenReader(`√ökol nelze splnit. Chyb√≠ ti ${missingItems.join(', ')}.`);
                }
                renderAll(document.activeElement);
            } catch (error) {
                console.error('Chyba p≈ôi p≈ôij√≠m√°n√≠ √∫kolu:', error);
                myoModals.showCustomModal('Nastala neoƒçek√°van√° chyba.', 'Chyba');
            }
        }

        function declineQuest() {
            try {
                const npcName = game.activeQuest.npc;
                const returnDays = Math.floor(Math.random() * (QUEST_DECLINE_RETURN_DAYS_MAX - QUEST_DECLINE_RETURN_DAYS_MIN + 1)) + QUEST_DECLINE_RETURN_DAYS_MIN;
                game.activeQuest.returnDay = game.day + returnDays;
                myoModals.showCustomModal(`√ökol od ${npcName} byl odm√≠tnut. ${npcName} se vr√°t√≠ za ${returnDays} dn√≠.`, '√ökol odm√≠tnut');
                announceToScreenReader(`√ökol odm√≠tnut. ${npcName} se vr√°t√≠ za ${returnDays} dn√≠.`);
                renderAll(document.activeElement);
            } catch (error) {
                console.error('Chyba p≈ôi odm√≠tnut√≠ √∫kolu:', error);
                myoModals.showCustomModal('Nastala neoƒçek√°van√° chyba.', 'Chyba');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.addEventListener('keydown', myoModals.handleGlobalModalKeyboard);
            initializeGame();
            populateSectionHeadings();
        });
    </script>
</body>
</html>